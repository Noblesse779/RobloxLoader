-- GUI หลัก
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "LockTargetGUI"
screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

-- กรอบ GUI (ลากได้)
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 150)
frame.Position = UDim2.new(0, 100, 0, 100)
frame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

-- ปุ่มล็อกเป้า
local lockButton = Instance.new("TextButton")
lockButton.Size = UDim2.new(0, 200, 0, 40)
lockButton.Position = UDim2.new(0, 10, 0, 20)
lockButton.Text = "🎯 Lock Nearest Enemy OFF"
lockButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
lockButton.TextColor3 = Color3.fromRGB(255, 255, 255)
lockButton.TextScaled = true
lockButton.Parent = frame

-- ปุ่มเปิด/ปิดเดินอิสระ
local walkButton = Instance.new("TextButton")
walkButton.Size = UDim2.new(0, 200, 0, 40)
walkButton.Position = UDim2.new(0, 10, 0, 75)
walkButton.Text = "🚶 Walk Control OFF"
walkButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
walkButton.TextColor3 = Color3.fromRGB(255, 255, 255)
walkButton.TextScaled = true
walkButton.Parent = frame

-- ตัวแปรหลัก
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer
local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")
local camera = workspace.CurrentCamera

local aiming = false
local walkEnabled = false

-- ฟังก์ชันหาเป้าใกล้สุด
local function getClosestEnemy()
	local players = Players:GetPlayers()
	local closest = nil
	local shortestDist = math.huge

	for _, player in pairs(players) do
		if player ~= localPlayer and player.Team ~= localPlayer.Team then
			local char = player.Character
			if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
				local dist = (char.HumanoidRootPart.Position - hrp.Position).Magnitude
				if dist < shortestDist then
					shortestDist = dist
					closest = player
				end
			end
		end
	end

	return closest
end

-- สลับสถานะล็อกเป้า
lockButton.MouseButton1Click:Connect(function()
	aiming = not aiming
	if aiming then
		lockButton.Text = "🎯 Lock Nearest Enemy ON"
	else
		lockButton.Text = "🎯 Lock Nearest Enemy OFF"
	end
end)

-- สลับสถานะเดินอิสระ
walkButton.MouseButton1Click:Connect(function()
	walkEnabled = not walkEnabled
	if walkEnabled then
		walkButton.Text = "🚶 Walk Control ON"
	else
		walkButton.Text = "🚶 Walk Control OFF"
	end
end)

-- ตัวแปรเก็บทิศทางเดิน
local moveDirection = Vector3.new(0,0,0)

-- อัปเดตทิศทางเดินตามปุ่มกด (ถ้าเปิดเดิน)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if not walkEnabled then return end

	if input.UserInputType == Enum.UserInputType.Keyboard then
		if input.KeyCode == Enum.KeyCode.W then
			moveDirection = moveDirection + Vector3.new(0,0,-1)
		elseif input.KeyCode == Enum.KeyCode.S then
			moveDirection = moveDirection + Vector3.new(0,0,1)
		elseif input.KeyCode == Enum.KeyCode.A then
			moveDirection = moveDirection + Vector3.new(-1,0,0)
		elseif input.KeyCode == Enum.KeyCode.D then
			moveDirection = moveDirection + Vector3.new(1,0,0)
		end
	end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if not walkEnabled then return end

	if input.UserInputType == Enum.UserInputType.Keyboard then
		if input.KeyCode == Enum.KeyCode.W then
			moveDirection = moveDirection - Vector3.new(0,0,-1)
		elseif input.KeyCode == Enum.KeyCode.S then
			moveDirection = moveDirection - Vector3.new(0,0,1)
		elseif input.KeyCode == Enum.KeyCode.A then
			moveDirection = moveDirection - Vector3.new(-1,0,0)
		elseif input.KeyCode == Enum.KeyCode.D then
			moveDirection = moveDirection - Vector3.new(1,0,0)
		end
	end
end)

-- อัปเดตกล้องและเดินทุกเฟรม
RunService.RenderStepped:Connect(function()
	-- ระบบล็อกเป้า
	if aiming then
		local target = getClosestEnemy()
		if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
			camera.CFrame = CFrame.new(camera.CFrame.Position, target.Character.HumanoidRootPart.Position)
		end
	end

	-- ระบบเดิน (ถ้าเปิด)
	if walkEnabled then
		if moveDirection.Magnitude > 0 then
			local camCFrame = camera.CFrame
			local moveVec = (camCFrame.RightVector * moveDirection.X) + (camCFrame.LookVector * moveDirection.Z)
			moveVec = Vector3.new(moveVec.X, 0, moveVec.Z).Unit
			humanoid:Move(moveVec, false)
		else
			humanoid:Move(Vector3.new(0,0,0), false)
		end
	else
		humanoid:Move(Vector3.new(0,0,0), false)
	end
end)
